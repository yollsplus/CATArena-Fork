#!/bin/bash

# =============================================================================
# Demo对战启动脚本
# =============================================================================
# 本脚本用于启动完整的Demo对战流程，包括：
#   1. 启动五子棋游戏环境服务器
#   2. 启动所有AI对战者服务
#   3. 启动竞技场系统进行对战
#   4. 生成对战报告
# =============================================================================

# 获取脚本所在目录的绝对路径
cur_dir=$(dirname "$0")

# =============================================================================
# 端口管理函数
# =============================================================================
# 功能：杀死占用指定端口的进程，确保端口可用
kill_port() {
    if [ -z "$1" ]; then
        echo "用法: kill_port <端口号>"
        return 1
    fi
    PORT=$1
    # 使用lsof命令查找占用端口的进程ID
    PID=$(sudo lsof -ti :"$PORT" 2>/dev/null)
    if [ -z "$PID" ]; then
        echo "端口 $PORT 未被任何进程占用。"
        return 0
    fi
    # 强制杀死占用端口的进程
    sudo kill -9 $PID
    echo "已杀死占用端口 $PORT 的进程: $PID"
}

# 切换到脚本所在目录
cd $cur_dir

# =============================================================================
# 步骤1：启动五子棋游戏环境服务器
# =============================================================================
echo "=== 启动五子棋游戏环境 ==="
cd gomoku
# 清理端口9000，确保游戏环境服务器可以正常启动
kill_port 9000
# 启动游戏环境服务器，监听9000端口
bash start_server.sh 9000 &
# 等待5秒让服务器完全启动
sleep 5
cd ../

# =============================================================================
# 步骤2：启动AI对战者服务
# =============================================================================
echo "=== 启动AI对战者服务 ==="
# 回到脚本所在目录
cd $cur_dir
# 显示当前目录内容（用于调试）
ls
# 启动所有AI对战者，使用默认参数：
# - round=1 (启动round_1目录下的AI)
# - env=gomoku (启动gomoku环境下的AI)
# - start_port=51000 (从51000端口开始分配)
bash start_ai_competitors.sh 
# 等待5秒让所有AI服务完全启动
sleep 5

# =============================================================================
# 步骤3：启动竞技场系统进行对战
# =============================================================================
echo "=== 启动竞技场对战系统 ==="
# 回到脚本所在的目录
cd $cur_dir
# 启动竞技场系统，使用demo配置文件
# --config: 指定对战配置文件
# 对战报告输出目录: ./reports/
python3 ./gomoku_Arena/start_arena.py --config ./gomoku_Arena/configs/demo_config.json 

